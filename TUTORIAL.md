## Развертывание системы

_Рабочий компьютер_ - компьютер администратора системы, с которого производится предварительная настройка системы HiTViSc и отправка команд по развертыванию системы на удаленный сервер. _Удаленный сервер_ - компьютер, на котором будет непосредственно развернута система HiTViSc, включая все ее компоненты, базы данных и веб-интерфейс конечного пользователя.

1. Скачать исходный код и подготовить _рабочий компьютер_:

```
# Убедиться, что находимся в рабочей директории: например, /home/user/work
git clone git@github.com:hitvisc/hitvisc.git
cd hitvisc/install
ssh-keygen #(3 раза нажать Enter для установки директории с ключами по умолчанию и пустого пароля)
cat ~/.ssh/id_rsa > keys/ansible.key
chmod 600 keys/ansible.key
cat ~/.ssh/id_rsa.pub #(скопировать содержимое публичного ключа для шага 2)
sudo apt install ansible
```

2. Подготовить к работе _удаленный сервер_. Предположим, что учетная запись администратора (root) доступна через ssh по ip-адресу [IP address] с паролем ansibleRootPasswd. В ходе установки на сервере будет создана учетная запись пользователя ansible с паролем ansiblePasswd.

```
ssh root@[IP address] #(ввести пароль пользователя root - ansibleRootPasswd)
useradd -m --shell /bin/bash ansible
passwd ansible #(ввести пароль для создаваемого пользователя - ansiblePasswd)
usermod -a -G sudo ansible
useradd -m --shell /bin/bash hitviscadm
addgroup hitvisc
usermod -a -G hitvisc hitviscadm
usermod -a -G hitvisc ansible
usermod -a -G www-data hitviscadm
mkdir -p /app/hitvisc/front
chown -R ansible:hitvisc /app/
hostname #(выведенное имя хоста понадобится для установки параметров на рабочем компьютере на шаге 3)

apt install -y git vim 
su ansible
cd /home/ansible
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
npm install -g pm2
mkdir -p ~/.ssh
vim ~/.ssh/authorized_keys #(вставить с новой строки содержимое публичного ключа рабочего компьютера, скопированное на шаге 1)
```

3. Установить на _рабочем компьютере_ настройки доступа к удаленному серверу:

```
# Убедиться, что находимся в рабочей директории: например, /home/user/work
cd hitvisc/install
cp group_vars/TargetServers.example group_vars/TargetServers
vim group_vars/TargetServers #(установить в файле group_vars/TargetServers актуальные параметры boinc_project_host, boinc_url_base и boinc_db_host, используя имя хоста и внешний ip-адрес удаленного сервера [IP address])
cp source/hitvisc/main/hitvisc.conf.example source/hitvisc/main/hitvisc.conf 
vim inventory.txt #(установить в файле inventory.txt имя хоста и внешний ip-адрес удаленного сервера [IP address])
```
При желании установить собственные значения параметров в файлах group_vars/TargetServers и source/hitvisc/main/hitvisc.conf.

Настройки, связанные с BOINC-проектом, функционирующим внутри системы HiTViSc, можно выбрать по своему усмотрению. Они задают параметры доступа к BOINC-проекту и прописаны в файле group_vars/TargetServers. Связка параметров boinc_url_base и boinc_project_name определяет уникальный, неизменный URL-адрес BOINC-проекта. Параметр boinc_project_caption определяет имя проекта, выводимое в BOINC-клиенте. Если планируется привлечение широкого круга добровольцев к участию в вычислениях, то рекомендуется заранее продумать URL-адрес и название проекта.

>boinc_project_host           : [REPLACE WITH YOUR SERVER HOSTNAME]  
>boinc_url_base               : http://[REPLACE WITH YOUR SERVER IP ADDRESS OR DOMAIN NAME]/  
>boinc_project_home           : hitboinc  
>boinc_db_host                : [REPLACE WITH YOUR SERVER HOSTNAME]  
>boinc_db_name                : hitboinc  
>boinc_db_user                : hitviscadm  
>boinc_db_password            : hitviscadmPasswd  
>boinc_project_name           : hitboinc  
>boinc_project_caption        : HiTViSc@home  

Следующая группа параметров в файле source/hitvisc/main/hitvisc.conf описывает основные системные настройки системы HiTViSc, и их рекомендуется оставить неизменными.

>registry_database        = hitvisc  
>hitvisc_api_dir          = /app/hitvisc/api  
>hitvisc_main_dir         = /app/hitvisc/main  
>hitvisc_data_dir         = /app/hitvisc/data  
>hitvisc_bio_dir          = /app/hitvisc/bio  
>hitvisc_log_dir          = /app/hitvisc/log  
>hitvisc_tmp_dir          = /app/hitvisc/tmp  

4. Установить back-end на удаленном сервере.

Развертывание back-end части Системы обеспечивается скриптами Ansible, выполняющими все необходимые действия по установке и настройке системного программного обеспечения. Последовательное выполнение скриптов позволяет устанавливать системное окружение пошагово с возможностью корректировки, если потребуется, в случае возникновения ошибок.

Для установки back-end, на _рабочем компьютере_ выполняется следующий набор команд:

```
# Убедиться, что находимся в рабочей директории: например, /home/user/work
cd hitvisc/install
# По запросу ввести пароль для пользователя ansible - ansiblePasswd
ansible-playbook hitvisc-install.yml -K 
ansible-playbook postgresql-install.yml -K
ansible-playbook hitvisc-main-install.yml -K
ansible-playbook boinc-install.yml -K
ansible-playbook hitvisc-boinc-install.yml -K
ansible-playbook registry-install.yml -K
ansible-playbook third-party-install.yml -K
```

В результате успешного выполнения команд будут созданы все необходимые системные директории в дереве директорий ``/app/*``, созданы и наполнены базовым набором данных необходимые таблицы в базе данных.

5. Установить front-end на _удаленном сервере_.

```
su ansible
cd /home/ansible
git clone https://github.com/hitvisc/hitvisc.git 
cd /home/ansible/hitvisc/frontend/nuxt-client/src/
npm install
npm run build
cd /home/ansible/hitvisc/frontend/backend/src/
npm install
npm run build

cd /app/hitvisc/front
mkdir -p /app/hitvisc/front/app/api
mkdir -p /app/hitvisc/front/app/client
cp -r /home/ansible/hitvisc/frontend/backend/src/dist /app/hitvisc/front/app/api/dist
cp -r /home/ansible/hitvisc/frontend/backend/src/node_modules /app/hitvisc/front/app/api/node_modules  
cp -r /home/ansible/hitvisc/frontend/nuxt-client/src/.output /app/hitvisc/front/app/client/.output
mkdir -p /app/hitvisc/front/sysdir
mkdir -p /app/hitvisc/front/storage
cp /home/ansible/hitvisc/frontend/upload_settings.conf.example /app/hitvisc/front/upload_settings.conf
cp /home/ansible/hitvisc/frontend/pm2.config.js /app/hitvisc/front/pm2.production.config.js
vim /app/hitvisc/front/pm2.production.config.js #(установить актуальные настройки)
exit #(вернуться под пользователем root)
chown -R hitviscadm:hitvisc /app
```

В файле настроек ``/app/hitvisc/front/pm2.production.config.js`` следующая группа параметров задает правила доступа к почтовому аккаунту, который будет использоваться в системе для подтверждения регистраций/восстановлений паролей пользователей: 

>EMAIL_HOST: "smtp.yandex.ru", (необходимо заменить на хост SMTP-сервера почтового аккаунта)  
>EMAIL_PORT: 465, (необходимо заменить на номер порта почтового аккаунта)  
>EMAIL_USER: "user@yandex.ru", (необходимо заменить на адрес e-mail почтового аккаунта)  
>EMAIL_PASSWORD: "apppassword", (необходимо заменить на пароль приложения почтового аккаунта)  

Для запуска front-end необходимо выполнить команды на _удаленном сервере_

```
su hitviscadm
cd /app/hitvisc/front
pm2 start pm2.production.config.js
```

6. Завершить подготовку базы данных на _рабочем компьютере_.

``
ansible-playbook registry-finalize.yml
``

После успешной установки back-end и front-end частей Системы, пользовательский веб-интерфейс Системы доступен из веб-браузера по адресу вида http://ADDRESS:PORT, в котором подстрока ADDRESS задана в файле install/inventory.txt в переменной 
```
ansible_host=<ip-адрес удаленного сервера>
```

а подстрока PORT задана в файле /app/hitvisc/front/pm2.production.config.js в переменной 
```
PORT: <номер веб-порта>
```


## Общий интерфейс системы

Общий интерфейс системы состоит из панели меню (слева) и рабочей области экрана, в которой реализован основной блок взаимодействия с пользователем.
Панель меню состоит из следующих разделов:
- Проекты – список проектов пользователя, функционал создания новых проектов,
- Ресурсы – список вычислительных ресурсов пользователя, включая тестовые, общедоступные и частные,
- Новости – информация о важных событиях системы, таких как обновление программного обеспечения, создание и завершение общедоступных проектов,
- Библиотека:
    - Мишени – библиотека мишеней, доступных для использования в виртуальном скрининге,
    - Лиганды – библиотека лигандов, доступных для использования в виртуальном скрининге,
- Уведомления – пользовательские уведомления о событиях в проектах, таких как завершение заданного числа заданий или нахождение заданного числа хитов в пользовательских проектах,
- Настройки – настройки системы, связанные с взаимодействием с конкретным пользователем.
    
![image](https://github.com/user-attachments/assets/e565fb58-7abb-45ae-8d82-debdb56e44ca)

Основной функционал системы связан с созданием проектов виртуального скрининга. Для пользователей доступны:
- Добавление проектов,
- Редактирование проектов,
- Использование результатов проекта.

## Добавление проектов

Для добавления проектов служит кнопка «Добавить» в разделе «Проекты».
![image](https://github.com/user-attachments/assets/dc92e1f7-16cd-4aab-893b-f397f1718dd5)

При нажатии на кнопку, появляется форма Помощника создания нового проекта. Помощник реализует четыре шага-этапа по созданию проекта с указанием необходимых параметров. 
На каждом шаге у пользователя есть возможность верифицировать заполненные данные, нажав кнопку «Далее» или перейти на следующий шаг без верификации.

![image](https://github.com/user-attachments/assets/4c9d4187-3fc4-48a9-909a-3fed18e637eb)

Первый шаг создания проекта – это его описание, задание мишени и библиотеки лигандов. Пользователь вводит название проекта, режим доступа к нему и описание.
Существует три режима доступа к проекту:
- Закрытый – проект не публикуется в системе для остальных пользователей; такой режим доступен только при использовании частных вычислительных ресурсов – без привлечения ресурсов волонтеров и других пользователей системы, 
- Частный – для пользователей системы доступна только общая информация о проекте,
- Общий – проект доступен для ознакомления всем пользователям системы, в том числе информация об исходных данных, параметрах выполнения эксперимента, его результатах.

![image](https://github.com/user-attachments/assets/37948e26-447f-4e7d-8a63-f87ea1d61411)

Мишень выбирается из библиотеки мишеней, библиотека лигандов выбирается из соответствующей библиотеки. Для ознакомления с функционалом создания редактирования и удаления библиотеки мишеней, перейдите в раздел инструкции "Управление библиотеками".
На следующем шаге необходимо выбрать расчетное приложение и задать параметры (протокол) молекулярного докинга в соответствии с выбранным приложением. В системе доступны две наиболее широко распространенные программы молекулярного докинга – AutoDock Vina и CmDock. Настройки протокола молекулярного докинга можно либо ввести вручную, либо загрузить соответствующим файлом.

![image](https://github.com/user-attachments/assets/c65284ce-acc0-45f5-9f61-dc43e0ebfff8)

![image](https://github.com/user-attachments/assets/a9b40298-4f4e-486e-bfe0-d862cbca0115)

Следующий этап создания проекта – это установка параметров эксперимента. На этом шаге устанавливаются критерии отбора хитов (энергия связывания или эффективность лиганда), критерий остановки (процент проверенных лигандов, число найденных хитов или процент хитов от числа лигандов), а также устанавливаются пользовательские оповещения.

![image](https://github.com/user-attachments/assets/94bcdfac-40ae-4268-a3b6-5415df7f93e6)

На этом же этапе выбираются вычислительные ресурсы, которые будут использованы при запуске проекта. Пользователю доступен выбора из следующих типов ресурсов:
- Тестовые ресурсы – высоконадежные и доступные вычислительные ресурсы, сопровождаемые Системой и используемые в ограниченном режиме для тестирования настроек проекта,
- Частные ресурсы – ресурсы, добавленные пользователем из собственных доступных и в приоритетном порядке используемые для расчета проектов пользователя; при выборе закрытого или частного проекта, расчеты могут выполняться только на частных ресурсах,
- Общедоступные ресурсы – ресурсы других пользователей системы, отмеченные как общедоступные, ресурсы волонтеров; общедоступные ресурсы могут использоваться только в рамках открытых проектов, информация о результатах которых доступна всем пользователям системы.

Заключительный шаг создания проекта – это его запуск. На этом шаге пользователю предоставляется сводка всех параметров проекта и предлагается отправить проект на запуск расчетов. В качестве альтернативы – если пользователь еще не готов отправлять проект на расчеты, а хочет отложить это действие, например, для уточнения параметров – можно сохранить проект и запустить позже.

![image](https://github.com/user-attachments/assets/cc1282d0-bd60-451c-b999-38da9fdd5504)

В результате выполнения всех шагов Помощника, при успешном прохождении верификации, будет создан проект на доступных вычислительных ресурсах. Процедура виртуального скрининга является вычислительноемкой, поэтому она может занимать от нескольких часов до нескольких месяцев в зависимости от установленных параметров, размера используемой библиотеки лигандов и объема доступных вычислительных ресурсов. 

## Редактирование и удаление проектов

Созданный ранее сохраненный проект можно отредактировать и/или удалить. Для этого в интерфейсе системы, в основном окне списка проектов, на карточке соответствующего проекта необходимо выбрать пункт «Редактировать проект» или «Удалить проект». Функционал редактирования проекта аналогичен функционалу создания проекта – с использованием того же Помощника и прохождением тех же шагов, но с заполненными ранее полями.

![image](https://github.com/user-attachments/assets/9f1c7cde-c62d-432b-9a11-0397c54e6aa0)

## Использование результатов проекта

Для доступа к результатам проекта в интерфейсе системы, в основном окне списка проектов, на карточке соответствующего проекта необходимо нажать кнопку «Результаты».

![image](https://github.com/user-attachments/assets/ddaeaa6d-1049-41c6-9f12-912ba1260e93)


Результаты доступны в виде трех файлов: файл с информацией о всех хитах, файл с таблицей химически разнообразных хитов и файл-визуализация множества хитов.

![image](https://github.com/user-attachments/assets/37f08c1e-95b8-4285-9efd-4a310d6082d7)

## Управление ресурсами

Ресурсы – это вычислительные узлы (персональные или рабочие компьютеры, сервера, вычислительные кластеры), используемые для выполнения расчетов (моделирования, молекулярного докинга) в рамках виртуального скрининга. Для решения общей задачи виртуального скрининга, полная база лигандов разбивается на части, формируя для вычислительного узла задания, в рамках которых необходимо выполнить молекулярный докинг небольшого числа лигандов против мишени.
В системе выделяется три типа ресурсов:
- Тестовые ресурсы – высоконадежные и доступные вычислительные ресурсы, сопровождаемые Системой и используемые в ограниченном режиме для тестирования настроек проекта,
- Частные ресурсы – ресурсы, добавленные пользователем из собственных доступных и в приоритетном порядке используемые для расчета проектов пользователя; при выборе закрытого или частного проекта, расчеты могут выполняться только на частных ресурсах,
- Общедоступные ресурсы – ресурсы других пользователей системы, отмеченные как общедоступные, ресурсы волонтеров; общедоступные ресурсы могут использоваться только в рамках открытых проектов, информация о результатах которых доступна всем пользователям системы.
Для управления ресурсами, необходимо в панели меню выбрать соответствующий раздел.

![image](https://github.com/user-attachments/assets/d3c3840c-8074-418b-8487-388464fd24bd)

### Общие ресурсы 

При выборе пункта меню «Ресурсы-Общие», в рабочем окне отображается список доступных общих ресурсов системы.

![image](https://github.com/user-attachments/assets/a258baa3-125b-42ce-897d-6eb8e501eb0f)

В списке общих ресурсов системы отображается следующая информация:
- имя вычислительного узла, 
- дата последнего обращения вычислительного узла на сервер системы (для получения задания или отчета о результатах), 
- количество текущих заданий, которые были направлены ранее на вычислительный узел и для которых еще не получены результаты,
- общее количество завершенных узлом заданий, 
- режим доступа к вычислительному узлу.
Для вычислительных узлов, добавленных пользователем, доступна возможность редактирования имени узла.

### Частные ресурсы 

При выборе пункта меню «Ресурсы-Частные», в рабочем окне отображается список доступных частных ресурсов системы.
В списке частных ресурсов системы отображается следующая информация:
- имя вычислительного узла, 
- дата последнего обращения вычислительного узла на сервер системы (для получения задания или отчета о результатах), 
- количество текущих заданий, которые были направлены ранее на вычислительный узел и для которых еще не получены результаты,
- общее количество завершенных узлом заданий, 
- режим доступа к вычислительному узлу.
Для вычислительных узлов доступна возможность редактирования имени узла.

### Тестовые ресурсы

При выборе пункта меню «Ресурсы-Тестовые», в рабочем окне отображается список доступных общих ресурсов системы.
В списке тестовых ресурсов системы отображается следующая информация:
- имя вычислительного узла, 
- дата последнего обращения вычислительного узла на сервер системы (для получения задания или отчета о результатах), 
- количество текущих заданий, которые были направлены ранее на вычислительный узел и для которых еще не получены результаты,
- общее количество завершенных узлом заданий, 
- режим доступа к вычислительному узлу.
Для вычислительных узлов, добавленных пользователем, доступна возможность редактирования имени узла.

### Добавление ресурсов

Для общих и частных ресурсов доступно добавление вычислительных узлов. 
При нажатии кнопки «Добавить» в соответствующем разделе ресурсов, появляется всплывающее окно, дающее инструкции по подключению нового вычислительного узла.

![image](https://github.com/user-attachments/assets/5b11a24d-5b71-42f7-abe7-80e487380a15)

Подключен может быть только тот вычислительный узел, на котором установлено соответствующее программное обеспечение – клиент BOINC. Подключение вычислительного узла выполняется штатными средствами клиента BOINC.

## Управление библиотеками

Библиотеки используются для структурирования хранения и использования, повторного использования в проектах информации о мишенях и лигандах, применяемых при выполнении виртуального скрининга.
Выбор соответствующего раздела библиотек производится посредством бокового меню.

![image](https://github.com/user-attachments/assets/ee222c4b-bec4-4bfb-abd3-9b0ef870fea9)

### Мишени

При выборе раздела бокового меню «Библиотека-Мишени», в рабочем окне отображается список доступных библиотек мишеней.

![image](https://github.com/user-attachments/assets/088a456f-8ac6-45c4-bd0a-ecc697522b89)

Библиотеки мишеней отображаются в виде карточек. На каждой карточке размещается следующая информация:
- Режим доступа,
- Автор или авторы,
- Создатель (пользователь, добавивший библиотеку),
- Краткое описание.
Для библиотек, созданных пользователем, доступны редактирование и удаление библиотеки.
Для добавления новой библиотеки мишени, необходимо нажать кнопку «Добавить» главного рабочего окна (рисунок А.16) и заполнить соответствующую форму (рисунок А.17).
При заполнении формы, необходимо указать следующую информацию:
- Название библиотеки мишени,
- Краткое описание библиотеки мишени,
- Авторство библиотеки,
- Источник, откуда получена библиотека,
- Режим доступа к библиотеке (закрытая, частная, общая),
- Источник файла мишени в формате PDB – это может быть отдельный PDB-файл или ID файла PDB в базе данных мишеней.
- Необходимость извлечь справочный лиганд, сохраненный в PDB-файле мишени.
После нажатия кнопки «Добавить мишень», новая библиотека появится в списке карточек библиотек мишеней, а также будет доступна для выбора при создании нового проекта.

![image](https://github.com/user-attachments/assets/a613b0c1-3a1e-4a43-8ff9-4e250644ba9b)

### Лиганды

При выборе раздела бокового меню «Библиотека-Лиганды», в рабочем окне отображается список доступных библиотек лигандов 

![image](https://github.com/user-attachments/assets/967da64b-141f-4621-a87f-c378008944de)

Библиотеки лигандов отображаются в виде карточек. На каждой карточке размещается следующая информация:
- Режим доступа,
- Автор или авторы,
- Создатель (пользователь, добавивший библиотеку), 
- Краткое описание.
Для библиотек, созданных пользователем, доступны редактирование и удаление библиотеки.
Для добавления новой библиотеки лигандов, необходимо нажать кнопку «Добавить» главного рабочего окна (рисунок А.16) и заполнить соответствующую форму (рисунок А.19).
При заполнении формы, необходимо указать следующую информацию:
- Название библиотеки (коллекции) лигандов,
- Краткое описание библиотеки лигандов,
- Авторство библиотеки,
- Источник, откуда получена библиотека,
- Режим доступа к библиотеке (закрытая, частная, общая),
- Источник файла лигандов – при небольшом размере файла, его можно загрузить напрямую; при большом размере файла можно указать ссылку на него на файлообменнике.
После нажатия кнопки «Добавить коллекцию лигандов», новая библиотека появится в списке карточек библиотек лигандов, а также будет доступна для выбора при создании нового проекта.

![image](https://github.com/user-attachments/assets/58355b72-593c-4cc8-ba1d-47b0fb14ac46)

## Вспомогательный функционал

Вспомогательный функционал системы связан с обеспечением дополнительных возможностей удобства пользователей и функционирования системы. К вспомогательному функционалу относятся разделы:
- Новости – информация о важных событиях системы, таких как обновление программного обеспечения, создание и завершение общедоступных проектов,
- Уведомления – пользовательские уведомления о событиях в проектах, таких как завершение заданного числа заданий или нахождение заданного числа хитов в пользовательских проектах,
- Настройки – настройки системы, связанные с взаимодействием с конкретным пользователем.
Доступ к разделам осуществляется из соответствующих пунктов бокового меню.

![image](https://github.com/user-attachments/assets/aab4cb71-0743-4ed6-ab7f-9ec4cb883340)





























